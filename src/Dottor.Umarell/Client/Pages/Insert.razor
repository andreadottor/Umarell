@page "/Insert"
@using System.ComponentModel.DataAnnotations
@implements IAsyncDisposable
@attribute [Authorize]

@inject IJSRuntime JS
@inject ApiProxyService ApiProxy
@inject IMessageBoxService MessageBoxService

<Page Title="Inserimento nuovo cantiere">

    <EditForm EditContext="editContext" OnValidSubmit="Save">
        <DataAnnotationsValidator />
        <div class="form-group">
            <label for="txtTitle">Titolo</label>
            <InputText @bind-Value="Title" class="form-control" id="txtTitle" />
            <ValidationMessage For="() => Title" />
        </div>

        <div class="form-group">
            <label for="fileImage">Foto</label>
            <InputFile OnChange="@LoadFiles" class="form-control" id="fileImage" />
        </div>

        <div class="form-group">
            <label for="map">Posizione</label>
            <div class="map-element" @ref="mapElement" id="map"></div>
            <ValidationMessage For="() => Latitude" />
        </div>
        <button type="submit" class="btn btn-primary mt-3">Salva</button>
    </EditForm>
    <hr />
    Latitude: @Latitude<br />
    Longitude: @Longitude<br />


</Page>



@code {
    private ElementReference mapElement;
    private IJSUnmarshalledObjectReference? mapModule;
    private IJSObjectReference? mapInstance;
    private DotNetObjectReference<Insert>? objRef;

    private double? Latitude { get; set; }
    private double? Longitude { get; set; }
    private IBrowserFile? Image { get; set; }
    [Required]
    [StringLength(250)]
    public string Title { get; set; }

    private EditContext? editContext;
    private ValidationMessageStore? messageStore;


    protected override void OnInitialized()
    {
        editContext = new(this);
        editContext.OnValidationRequested += HandleValidationRequested;
        messageStore = new(editContext);
    }

    private void HandleValidationRequested(object? sender, ValidationRequestedEventArgs args)
    {
        messageStore?.Clear();

        if (Latitude == null || Longitude == null)
        {
            messageStore?.Add(() => Latitude, "Posizione non selezionata.");
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            objRef = DotNetObjectReference.Create(this);
            mapModule = await JS.InvokeAsync<IJSUnmarshalledObjectReference>("import", "./Pages/Insert.razor.js");
            mapInstance = await mapModule.InvokeAsync<IJSObjectReference>("initMap", mapElement, objRef);
        }
    }

    [JSInvokable]
    public void SetMarker(double lat, double lon)
    {
        Latitude = lat;
        Longitude = lon;
        StateHasChanged();
    }

    private void LoadFiles(InputFileChangeEventArgs e)
    {
        Image = e.File;
    }

    private async Task Save()
    {
        var model = new BuildingSiteInsertModel();
        model.Title = Title;
        model.Latitude = Latitude.Value;
        model.Longitude = Longitude.Value;

        if (Image != null)
        {
            using Stream stream = Image.OpenReadStream();
            using MemoryStream ms = new MemoryStream();
            await stream.CopyToAsync(ms);

            model.FileName = Image.Name;
            model.FileContent = ms.ToArray();
        }
        var result = await ApiProxy.InsertBuildingSiteAsync(model);

        if (result)
        {
            await MessageBoxService.ShowAlertAsync("OK", "Inserimento nuovo cantiere avvenuto con successo");
            Image = null;
            Title = "";
            Latitude = null;
            Longitude = null;
        }
        else
        {
            await MessageBoxService.ShowAlertAsync("Error", "Errore durante l'inserimento del cantiere.");
        }
    }

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (mapInstance is not null)
            await mapInstance.DisposeAsync();

        if (mapModule is not null)
            await mapModule.DisposeAsync();

        objRef?.Dispose();
    }
}
